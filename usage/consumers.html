<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Consumers | MassTransit</title>
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    
    
    <link rel="preload" href="/MassTransit/assets/css/0.styles.e9548384.css" as="style"><link rel="preload" href="/MassTransit/assets/js/app.763fcc25.js" as="script"><link rel="preload" href="/MassTransit/assets/js/6.b9c46cbe.js" as="script"><link rel="preload" href="/MassTransit/assets/js/1.f2cfa088.js" as="script"><link rel="preload" href="/MassTransit/assets/js/80.6aefc97d.js" as="script"><link rel="prefetch" href="/MassTransit/assets/js/10.8a53d3c6.js"><link rel="prefetch" href="/MassTransit/assets/js/100.dea5063d.js"><link rel="prefetch" href="/MassTransit/assets/js/101.fdf33797.js"><link rel="prefetch" href="/MassTransit/assets/js/102.08802a09.js"><link rel="prefetch" href="/MassTransit/assets/js/103.94dfe6b2.js"><link rel="prefetch" href="/MassTransit/assets/js/104.a2200f50.js"><link rel="prefetch" href="/MassTransit/assets/js/105.f38fb744.js"><link rel="prefetch" href="/MassTransit/assets/js/106.5f0d3183.js"><link rel="prefetch" href="/MassTransit/assets/js/107.b3f0d8cf.js"><link rel="prefetch" href="/MassTransit/assets/js/108.59b314d5.js"><link rel="prefetch" href="/MassTransit/assets/js/109.876d62e4.js"><link rel="prefetch" href="/MassTransit/assets/js/11.489768a6.js"><link rel="prefetch" href="/MassTransit/assets/js/110.525aec89.js"><link rel="prefetch" href="/MassTransit/assets/js/111.5d7c6cef.js"><link rel="prefetch" href="/MassTransit/assets/js/12.ca878fb6.js"><link rel="prefetch" href="/MassTransit/assets/js/13.de967d55.js"><link rel="prefetch" href="/MassTransit/assets/js/14.80f79d01.js"><link rel="prefetch" href="/MassTransit/assets/js/15.f0ec9a0d.js"><link rel="prefetch" href="/MassTransit/assets/js/16.07e33012.js"><link rel="prefetch" href="/MassTransit/assets/js/17.a5458ce9.js"><link rel="prefetch" href="/MassTransit/assets/js/18.d0709395.js"><link rel="prefetch" href="/MassTransit/assets/js/19.d6ea4de4.js"><link rel="prefetch" href="/MassTransit/assets/js/20.6f83da94.js"><link rel="prefetch" href="/MassTransit/assets/js/21.394a4a17.js"><link rel="prefetch" href="/MassTransit/assets/js/22.d356c42c.js"><link rel="prefetch" href="/MassTransit/assets/js/23.803d54aa.js"><link rel="prefetch" href="/MassTransit/assets/js/24.9621b1de.js"><link rel="prefetch" href="/MassTransit/assets/js/25.673aa562.js"><link rel="prefetch" href="/MassTransit/assets/js/26.08518995.js"><link rel="prefetch" href="/MassTransit/assets/js/27.8c9631cd.js"><link rel="prefetch" href="/MassTransit/assets/js/28.2bcebacf.js"><link rel="prefetch" href="/MassTransit/assets/js/29.d80bacb6.js"><link rel="prefetch" href="/MassTransit/assets/js/30.cdc44409.js"><link rel="prefetch" href="/MassTransit/assets/js/31.f476159a.js"><link rel="prefetch" href="/MassTransit/assets/js/32.31b6eefe.js"><link rel="prefetch" href="/MassTransit/assets/js/33.79798b43.js"><link rel="prefetch" href="/MassTransit/assets/js/34.cc04befa.js"><link rel="prefetch" href="/MassTransit/assets/js/35.f29df75f.js"><link rel="prefetch" href="/MassTransit/assets/js/36.e9d6cc6d.js"><link rel="prefetch" href="/MassTransit/assets/js/37.dd12c8f5.js"><link rel="prefetch" href="/MassTransit/assets/js/38.31ac2f25.js"><link rel="prefetch" href="/MassTransit/assets/js/39.44e23d20.js"><link rel="prefetch" href="/MassTransit/assets/js/4.6ac43b74.js"><link rel="prefetch" href="/MassTransit/assets/js/40.a5e5045c.js"><link rel="prefetch" href="/MassTransit/assets/js/41.33aebd66.js"><link rel="prefetch" href="/MassTransit/assets/js/42.b885c43e.js"><link rel="prefetch" href="/MassTransit/assets/js/43.ebbd1e2a.js"><link rel="prefetch" href="/MassTransit/assets/js/44.f87ec852.js"><link rel="prefetch" href="/MassTransit/assets/js/45.53e426f0.js"><link rel="prefetch" href="/MassTransit/assets/js/46.21f60550.js"><link rel="prefetch" href="/MassTransit/assets/js/47.85684ee0.js"><link rel="prefetch" href="/MassTransit/assets/js/48.904c9b27.js"><link rel="prefetch" href="/MassTransit/assets/js/49.2ef354b5.js"><link rel="prefetch" href="/MassTransit/assets/js/5.413cd6be.js"><link rel="prefetch" href="/MassTransit/assets/js/50.54704214.js"><link rel="prefetch" href="/MassTransit/assets/js/51.4cc1c6f9.js"><link rel="prefetch" href="/MassTransit/assets/js/52.a945a897.js"><link rel="prefetch" href="/MassTransit/assets/js/53.2372d01e.js"><link rel="prefetch" href="/MassTransit/assets/js/54.d69d0b89.js"><link rel="prefetch" href="/MassTransit/assets/js/55.ee9680f6.js"><link rel="prefetch" href="/MassTransit/assets/js/56.ffd754c3.js"><link rel="prefetch" href="/MassTransit/assets/js/57.116a2a32.js"><link rel="prefetch" href="/MassTransit/assets/js/58.d3335fc9.js"><link rel="prefetch" href="/MassTransit/assets/js/59.d0a1c513.js"><link rel="prefetch" href="/MassTransit/assets/js/60.ac18fdea.js"><link rel="prefetch" href="/MassTransit/assets/js/61.4e20793d.js"><link rel="prefetch" href="/MassTransit/assets/js/62.bcf0b140.js"><link rel="prefetch" href="/MassTransit/assets/js/63.52ae8ff6.js"><link rel="prefetch" href="/MassTransit/assets/js/64.819c10c7.js"><link rel="prefetch" href="/MassTransit/assets/js/65.3682be0f.js"><link rel="prefetch" href="/MassTransit/assets/js/66.5e442452.js"><link rel="prefetch" href="/MassTransit/assets/js/67.f0901a9e.js"><link rel="prefetch" href="/MassTransit/assets/js/68.edf45a54.js"><link rel="prefetch" href="/MassTransit/assets/js/69.0691d2ff.js"><link rel="prefetch" href="/MassTransit/assets/js/7.8a51af61.js"><link rel="prefetch" href="/MassTransit/assets/js/70.8e280419.js"><link rel="prefetch" href="/MassTransit/assets/js/71.d655551b.js"><link rel="prefetch" href="/MassTransit/assets/js/72.9f171999.js"><link rel="prefetch" href="/MassTransit/assets/js/73.38a47796.js"><link rel="prefetch" href="/MassTransit/assets/js/74.1753e133.js"><link rel="prefetch" href="/MassTransit/assets/js/75.28f9b3e6.js"><link rel="prefetch" href="/MassTransit/assets/js/76.6dbd3b9e.js"><link rel="prefetch" href="/MassTransit/assets/js/77.7e7a6a46.js"><link rel="prefetch" href="/MassTransit/assets/js/78.f603b82b.js"><link rel="prefetch" href="/MassTransit/assets/js/79.5cee3c98.js"><link rel="prefetch" href="/MassTransit/assets/js/8.6b741284.js"><link rel="prefetch" href="/MassTransit/assets/js/81.dcaa7545.js"><link rel="prefetch" href="/MassTransit/assets/js/82.4f71f3b3.js"><link rel="prefetch" href="/MassTransit/assets/js/83.602dc14d.js"><link rel="prefetch" href="/MassTransit/assets/js/84.b2e3702c.js"><link rel="prefetch" href="/MassTransit/assets/js/85.55a4f6af.js"><link rel="prefetch" href="/MassTransit/assets/js/86.f75a06f2.js"><link rel="prefetch" href="/MassTransit/assets/js/87.efc02065.js"><link rel="prefetch" href="/MassTransit/assets/js/88.60fb1dd8.js"><link rel="prefetch" href="/MassTransit/assets/js/89.5dc2cfdb.js"><link rel="prefetch" href="/MassTransit/assets/js/9.9f129a0e.js"><link rel="prefetch" href="/MassTransit/assets/js/90.c3da6b52.js"><link rel="prefetch" href="/MassTransit/assets/js/91.4f25ae4d.js"><link rel="prefetch" href="/MassTransit/assets/js/92.ff3a8464.js"><link rel="prefetch" href="/MassTransit/assets/js/93.26d099c6.js"><link rel="prefetch" href="/MassTransit/assets/js/94.395a5fdd.js"><link rel="prefetch" href="/MassTransit/assets/js/95.885d64a6.js"><link rel="prefetch" href="/MassTransit/assets/js/96.438fc819.js"><link rel="prefetch" href="/MassTransit/assets/js/97.3fe82e70.js"><link rel="prefetch" href="/MassTransit/assets/js/98.6add9580.js"><link rel="prefetch" href="/MassTransit/assets/js/99.d7afcafc.js"><link rel="prefetch" href="/MassTransit/assets/js/vuejs-paginate.55199f2c.js">
    <link rel="stylesheet" href="/MassTransit/assets/css/0.styles.e9548384.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MassTransit/" class="home-link router-link-active"><img src="/MassTransit/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MassTransit/updates/" class="nav-link">Blog</a></div><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MassTransit/updates/" class="nav-link">Blog</a></div><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/MassTransit/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/MassTransit/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/MassTransit/usage/consumers.html" class="active sidebar-link">Consumers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/consumers.html#consumer" class="sidebar-link">Consumer</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/consumers.html#instance" class="sidebar-link">Instance</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/consumers.html#handler" class="sidebar-link">Handler</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/consumers.html#observer" class="sidebar-link">Observer</a></li></ul></li><li><a href="/MassTransit/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/MassTransit/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/MassTransit/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/sagas/" class="sidebar-heading clickable"><span>Sagas</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/testing.html" class="sidebar-link">Testing</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MassTransit/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="consumers"><a href="#consumers" class="header-anchor">#</a> Consumers</h1> <p>A consumer is a class that may consume one or more message types. Each message type is defined by the <code>IConsumer&lt;T&gt;</code> interface, where <code>T</code> is the message type.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateCustomerConsumer</span> <span class="token punctuation">:</span>
    <span class="token class-name">IConsumer</span><span class="token operator">&lt;</span>UpdateCustomerAddress<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Consume</span><span class="token punctuation">(</span>ConsumeContext<span class="token operator">&lt;</span>UpdateCustomerAddress<span class="token operator">&gt;</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Console<span class="token punctuation">.</span>Out<span class="token punctuation">.</span><span class="token function">WriteLineAsync</span><span class="token punctuation">(</span>$<span class="token string">&quot;Updating customer: {context.Message.CustomerId}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// update the customer address</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When a consumer is configured on a receive endpoint, and a message type consumed by the consumer is received, an instance of the consumer is created (using a consumer factory, which is a delegate, or a container-specific consumer factory from one of the supported <a href="/MassTransit/usage/containers/">containers</a>). The message (wrapped in a <code>ConsumeContext</code>) is then delivered to the consumer via the <code>Consume</code> method.</p> <p>The <code>Consume</code> method is asynchronous, and returns a Task. The task is awaited by MassTransit, during which time the message is unavailable to other receive endpoints. If the consume method completes successfully (a task status of RanToCompletion), the message is acknowledged and removed from the queue.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>If the consumer faults (such as throwing an exception, resulting in a task status of Faulted), or is somehow cancelled (TaskStatus of Canceled), the exception is propagated back up the pipeline where it can ultimately be retried or moved to an error queue.</p></div> <h2 id="consumer"><a href="#consumer" class="header-anchor">#</a> Consumer</h2> <p>For a consumer to receive messages, the consumer must be connected to a receive endpoint. This is done during bus configuration, particularly within the configuration of a receive endpoint.</p> <p>An example of connecting a consumer to a receive endpoint is shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;customer_update_queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Consumer</span><span class="token punctuation">&lt;</span><span class="token class-name">UpdateCustomerConsumer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The example creates a bus, which connects to the RabbitMQ running on the local machine, using the default username and password (guest/guest). On that bus. a single receive endpoint is created with the name <em>customer_update_queue</em>. The consumer is connected using the simplest method, which accepts a consumer class with a default constructor.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>When a consumer is connected to a receive endpoint, the combined set of message types consumed by all of the consumers connected to the same receive endpoint are <em>subscribed</em> to the queue. The subscription method varies by broker, in the case of RabbitMQ exchange bindings are created for the message types to the exchange/queue for the receive endpoint.</p> <p>These subscriptions are persistent, and remain in place after the process exits. This ensures that messages published or sent that would be delivered to one of the receive endpoint consumers are saved even is the process is terminated. When the process is started, messages waiting in the queue will be delivered to the consumer(s).</p></div> <h3 id="consumer-factories"><a href="#consumer-factories" class="header-anchor">#</a> Consumer Factories</h3> <p>The above example connects the consumer using a default constructor consumer factory. There are several other consumer factories supported, as shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;customer_update_queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// an anonymous factory method</span>
        e<span class="token punctuation">.</span><span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">YourConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// an existing consumer factory for the consumer type</span>
        e<span class="token punctuation">.</span><span class="token function">Consumer</span><span class="token punctuation">(</span>consumerFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// a type-based factory that returns an object (container friendly)</span>
        e<span class="token punctuation">.</span><span class="token function">Consumer</span><span class="token punctuation">(</span>consumerType<span class="token punctuation">,</span> type <span class="token operator">=&gt;</span> Activator<span class="token punctuation">.</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// an anonymous factory method, with some middleware goodness</span>
        e<span class="token punctuation">.</span><span class="token function">Consumer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">YourConsumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> x <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            <span class="token comment">// add middleware to the consumer pipeline</span>
            x<span class="token punctuation">.</span><span class="token function">UseExecuteAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span>Out<span class="token punctuation">.</span><span class="token function">WriteLineAsync</span><span class="token punctuation">(</span><span class="token string">&quot;Consumer created&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="connect-consumers"><a href="#connect-consumers" class="header-anchor">#</a> Connect Consumers</h3> <p>Once a bus has been configured, returning an <code>IBusControl</code> reference, the receive endpoints have been created and cannot be modified. The bus itself, however, provides a temporary (auto-delete) queue which can be used to receive messages. To connect a consumer to the bus temporary queue, a series of <em>Connect</em> methods can be used.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Published messages will not be received by the temporary queue. Because the queue is temporary, when consumers are connected no bindings or subscriptions are created. This makes it very fast for transient consumers, and avoids thrashing the message broker with temporary bindings.</p></div> <p>The temporary queue is useful to receive request responses and faults (via the response/fault address header) and routing slip events (via an event subscription in the routing slip).</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

busControl<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ConnectHandle</span> handle <span class="token operator">=</span> busControl<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">ConnectConsumer</span><span class="token punctuation">&lt;</span><span class="token class-name">FaultConsumer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

handle<span class="token punctuation">.</span><span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// disconnect the consumer from the bus pipeline</span>
</code></pre></div><p>In addition to the <code>ConnectConsumer</code> method, methods for each consumer type are also included (<code>ConnectHandler</code>, <code>ConnectInstance</code>, <code>ConnectSaga</code>, and <code>ConnectStateMachineSaga</code>).</p> <h2 id="instance"><a href="#instance" class="header-anchor">#</a> Instance</h2> <p>While using a consumer instance per message is highly suggested, it is possible to connect an existing consumer instance which will be called for every message. The consumer <em>must</em> be thread-safe, as the <code>Consume</code> method will be called from multiple threads simultaneously. To connect an existing instance, see the example below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;customer_update_queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">Instance</span><span class="token punctuation">(</span>existingConsumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="undeliverable-messages"><a href="#undeliverable-messages" class="header-anchor">#</a> Undeliverable Messages</h3> <p>If the configuration of an endpoint changes, or if a message is mistakenly sent to an endpoint, it is possible that a message type is received that does not have any connected consumers. If this occurs, the message is moved to a <em>_skipped</em> queue (prefixed by the original queue name). The original message content is retained, and additional headers are added to indicate the host which moved the message.</p> <h2 id="handler"><a href="#handler" class="header-anchor">#</a> Handler</h2> <p>While creating a consumer is the preferred way to consume messages, it is also possible to create a simple message handler. By specifying a method, anonymous method, or lambda method, a message can be consumed on a receive endpoint.</p> <p>To configure a simple message handler, refer to the example below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;customer_update_queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handler</span><span class="token punctuation">&lt;</span><span class="token class-name">UpdateCustomerAddress</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span>
            <span class="token keyword">return</span> Console<span class="token punctuation">.</span>Out<span class="token punctuation">.</span><span class="token function">WriteLineAsync</span><span class="token punctuation">(</span>$<span class="token string">&quot;Update customer address received: {context.Message.CustomerId}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>In this case, the method is called for each message received. No consumer is created, and no lifecycle management is performed.</p> <h2 id="observer"><a href="#observer" class="header-anchor">#</a> Observer</h2> <p>With the addition of the <code>IObserver</code> interface, the concept of an observer was added to the .NET framework. MassTransit supports the direct connection of observers to receive endpoints.</p> <blockquote><p>Unfortunately, observers are not asynchronous. Because of this, it is not possible to play nice with the async support provided by the compiler when using an observer.</p></blockquote> <p>An observer is defined using the built-in <code>IObserver&lt;T&gt;</code> interface, as shown below.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerAddressUpdatedObserver</span> <span class="token punctuation">:</span>
    <span class="token class-name">IObserver</span><span class="token operator">&lt;</span>ConsumeContext<span class="token operator">&lt;</span>CustomerAddressUpdated<span class="token operator">&gt;&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnNext</span><span class="token punctuation">(</span>ConsumeContext<span class="token operator">&lt;</span>CustomerAddressUpdated<span class="token operator">&gt;</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Customer address was updated: {0}&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>CustomerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnError</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> error<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once created, the observer is connected to the receive endpoint similar to a consumer instance.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingRabbitMq</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
    cfg<span class="token punctuation">.</span><span class="token function">Host</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;customer_update_queue&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Observer</span><span class="token punctuation">&lt;</span><span class="token class-name">CustomerAddressUpdatedObserver</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/consumers.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/11/2019, 3:58:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/MassTransit/usage/messages.html" class="prev">Messages</a></span> <span class="next"><a href="/MassTransit/usage/producers.html">Producers</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MassTransit/assets/js/app.763fcc25.js" defer></script><script src="/MassTransit/assets/js/6.b9c46cbe.js" defer></script><script src="/MassTransit/assets/js/1.f2cfa088.js" defer></script><script src="/MassTransit/assets/js/80.6aefc97d.js" defer></script>
  </body>
</html>
