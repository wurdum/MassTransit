<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Automatonymous | MassTransit</title>
    <meta name="description" content="A free, open-source distributed application framework for .NET.">
    
    
    <link rel="preload" href="/MassTransit/assets/css/0.styles.e9548384.css" as="style"><link rel="preload" href="/MassTransit/assets/js/app.763fcc25.js" as="script"><link rel="preload" href="/MassTransit/assets/js/6.b9c46cbe.js" as="script"><link rel="preload" href="/MassTransit/assets/js/1.f2cfa088.js" as="script"><link rel="preload" href="/MassTransit/assets/js/101.fdf33797.js" as="script"><link rel="prefetch" href="/MassTransit/assets/js/10.8a53d3c6.js"><link rel="prefetch" href="/MassTransit/assets/js/100.dea5063d.js"><link rel="prefetch" href="/MassTransit/assets/js/102.08802a09.js"><link rel="prefetch" href="/MassTransit/assets/js/103.94dfe6b2.js"><link rel="prefetch" href="/MassTransit/assets/js/104.a2200f50.js"><link rel="prefetch" href="/MassTransit/assets/js/105.f38fb744.js"><link rel="prefetch" href="/MassTransit/assets/js/106.5f0d3183.js"><link rel="prefetch" href="/MassTransit/assets/js/107.b3f0d8cf.js"><link rel="prefetch" href="/MassTransit/assets/js/108.59b314d5.js"><link rel="prefetch" href="/MassTransit/assets/js/109.876d62e4.js"><link rel="prefetch" href="/MassTransit/assets/js/11.489768a6.js"><link rel="prefetch" href="/MassTransit/assets/js/110.525aec89.js"><link rel="prefetch" href="/MassTransit/assets/js/111.5d7c6cef.js"><link rel="prefetch" href="/MassTransit/assets/js/12.ca878fb6.js"><link rel="prefetch" href="/MassTransit/assets/js/13.de967d55.js"><link rel="prefetch" href="/MassTransit/assets/js/14.80f79d01.js"><link rel="prefetch" href="/MassTransit/assets/js/15.f0ec9a0d.js"><link rel="prefetch" href="/MassTransit/assets/js/16.07e33012.js"><link rel="prefetch" href="/MassTransit/assets/js/17.a5458ce9.js"><link rel="prefetch" href="/MassTransit/assets/js/18.d0709395.js"><link rel="prefetch" href="/MassTransit/assets/js/19.d6ea4de4.js"><link rel="prefetch" href="/MassTransit/assets/js/20.6f83da94.js"><link rel="prefetch" href="/MassTransit/assets/js/21.394a4a17.js"><link rel="prefetch" href="/MassTransit/assets/js/22.d356c42c.js"><link rel="prefetch" href="/MassTransit/assets/js/23.803d54aa.js"><link rel="prefetch" href="/MassTransit/assets/js/24.9621b1de.js"><link rel="prefetch" href="/MassTransit/assets/js/25.673aa562.js"><link rel="prefetch" href="/MassTransit/assets/js/26.08518995.js"><link rel="prefetch" href="/MassTransit/assets/js/27.8c9631cd.js"><link rel="prefetch" href="/MassTransit/assets/js/28.2bcebacf.js"><link rel="prefetch" href="/MassTransit/assets/js/29.d80bacb6.js"><link rel="prefetch" href="/MassTransit/assets/js/30.cdc44409.js"><link rel="prefetch" href="/MassTransit/assets/js/31.f476159a.js"><link rel="prefetch" href="/MassTransit/assets/js/32.31b6eefe.js"><link rel="prefetch" href="/MassTransit/assets/js/33.79798b43.js"><link rel="prefetch" href="/MassTransit/assets/js/34.cc04befa.js"><link rel="prefetch" href="/MassTransit/assets/js/35.f29df75f.js"><link rel="prefetch" href="/MassTransit/assets/js/36.e9d6cc6d.js"><link rel="prefetch" href="/MassTransit/assets/js/37.dd12c8f5.js"><link rel="prefetch" href="/MassTransit/assets/js/38.31ac2f25.js"><link rel="prefetch" href="/MassTransit/assets/js/39.44e23d20.js"><link rel="prefetch" href="/MassTransit/assets/js/4.6ac43b74.js"><link rel="prefetch" href="/MassTransit/assets/js/40.a5e5045c.js"><link rel="prefetch" href="/MassTransit/assets/js/41.33aebd66.js"><link rel="prefetch" href="/MassTransit/assets/js/42.b885c43e.js"><link rel="prefetch" href="/MassTransit/assets/js/43.ebbd1e2a.js"><link rel="prefetch" href="/MassTransit/assets/js/44.f87ec852.js"><link rel="prefetch" href="/MassTransit/assets/js/45.53e426f0.js"><link rel="prefetch" href="/MassTransit/assets/js/46.21f60550.js"><link rel="prefetch" href="/MassTransit/assets/js/47.85684ee0.js"><link rel="prefetch" href="/MassTransit/assets/js/48.904c9b27.js"><link rel="prefetch" href="/MassTransit/assets/js/49.2ef354b5.js"><link rel="prefetch" href="/MassTransit/assets/js/5.413cd6be.js"><link rel="prefetch" href="/MassTransit/assets/js/50.54704214.js"><link rel="prefetch" href="/MassTransit/assets/js/51.4cc1c6f9.js"><link rel="prefetch" href="/MassTransit/assets/js/52.a945a897.js"><link rel="prefetch" href="/MassTransit/assets/js/53.2372d01e.js"><link rel="prefetch" href="/MassTransit/assets/js/54.d69d0b89.js"><link rel="prefetch" href="/MassTransit/assets/js/55.ee9680f6.js"><link rel="prefetch" href="/MassTransit/assets/js/56.ffd754c3.js"><link rel="prefetch" href="/MassTransit/assets/js/57.116a2a32.js"><link rel="prefetch" href="/MassTransit/assets/js/58.d3335fc9.js"><link rel="prefetch" href="/MassTransit/assets/js/59.d0a1c513.js"><link rel="prefetch" href="/MassTransit/assets/js/60.ac18fdea.js"><link rel="prefetch" href="/MassTransit/assets/js/61.4e20793d.js"><link rel="prefetch" href="/MassTransit/assets/js/62.bcf0b140.js"><link rel="prefetch" href="/MassTransit/assets/js/63.52ae8ff6.js"><link rel="prefetch" href="/MassTransit/assets/js/64.819c10c7.js"><link rel="prefetch" href="/MassTransit/assets/js/65.3682be0f.js"><link rel="prefetch" href="/MassTransit/assets/js/66.5e442452.js"><link rel="prefetch" href="/MassTransit/assets/js/67.f0901a9e.js"><link rel="prefetch" href="/MassTransit/assets/js/68.edf45a54.js"><link rel="prefetch" href="/MassTransit/assets/js/69.0691d2ff.js"><link rel="prefetch" href="/MassTransit/assets/js/7.8a51af61.js"><link rel="prefetch" href="/MassTransit/assets/js/70.8e280419.js"><link rel="prefetch" href="/MassTransit/assets/js/71.d655551b.js"><link rel="prefetch" href="/MassTransit/assets/js/72.9f171999.js"><link rel="prefetch" href="/MassTransit/assets/js/73.38a47796.js"><link rel="prefetch" href="/MassTransit/assets/js/74.1753e133.js"><link rel="prefetch" href="/MassTransit/assets/js/75.28f9b3e6.js"><link rel="prefetch" href="/MassTransit/assets/js/76.6dbd3b9e.js"><link rel="prefetch" href="/MassTransit/assets/js/77.7e7a6a46.js"><link rel="prefetch" href="/MassTransit/assets/js/78.f603b82b.js"><link rel="prefetch" href="/MassTransit/assets/js/79.5cee3c98.js"><link rel="prefetch" href="/MassTransit/assets/js/8.6b741284.js"><link rel="prefetch" href="/MassTransit/assets/js/80.6aefc97d.js"><link rel="prefetch" href="/MassTransit/assets/js/81.dcaa7545.js"><link rel="prefetch" href="/MassTransit/assets/js/82.4f71f3b3.js"><link rel="prefetch" href="/MassTransit/assets/js/83.602dc14d.js"><link rel="prefetch" href="/MassTransit/assets/js/84.b2e3702c.js"><link rel="prefetch" href="/MassTransit/assets/js/85.55a4f6af.js"><link rel="prefetch" href="/MassTransit/assets/js/86.f75a06f2.js"><link rel="prefetch" href="/MassTransit/assets/js/87.efc02065.js"><link rel="prefetch" href="/MassTransit/assets/js/88.60fb1dd8.js"><link rel="prefetch" href="/MassTransit/assets/js/89.5dc2cfdb.js"><link rel="prefetch" href="/MassTransit/assets/js/9.9f129a0e.js"><link rel="prefetch" href="/MassTransit/assets/js/90.c3da6b52.js"><link rel="prefetch" href="/MassTransit/assets/js/91.4f25ae4d.js"><link rel="prefetch" href="/MassTransit/assets/js/92.ff3a8464.js"><link rel="prefetch" href="/MassTransit/assets/js/93.26d099c6.js"><link rel="prefetch" href="/MassTransit/assets/js/94.395a5fdd.js"><link rel="prefetch" href="/MassTransit/assets/js/95.885d64a6.js"><link rel="prefetch" href="/MassTransit/assets/js/96.438fc819.js"><link rel="prefetch" href="/MassTransit/assets/js/97.3fe82e70.js"><link rel="prefetch" href="/MassTransit/assets/js/98.6add9580.js"><link rel="prefetch" href="/MassTransit/assets/js/99.d7afcafc.js"><link rel="prefetch" href="/MassTransit/assets/js/vuejs-paginate.55199f2c.js">
    <link rel="stylesheet" href="/MassTransit/assets/css/0.styles.e9548384.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/MassTransit/" class="home-link router-link-active"><img src="/MassTransit/mt-logo-small.png" alt="MassTransit" class="logo"> <span class="site-name can-hide">MassTransit</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/MassTransit/updates/" class="nav-link">Blog</a></div><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/MassTransit/updates/" class="nav-link">Blog</a></div><div class="nav-item"><a href="https://gitter.im/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitter
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://nuget.org/packages/MassTransit" target="_blank" rel="noopener noreferrer" class="nav-link external">
  NuGet
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/MassTransit/MassTransit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/MassTransit/getting-started/" class="sidebar-heading clickable"><span>Getting Started</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/getting-started/upgrade-v6.html" class="sidebar-link">Upgrading</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/MassTransit/usage/" class="sidebar-heading clickable router-link-active open"><span>Using MassTransit</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/configuration.html" class="sidebar-link">Configuration</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/transports/" class="sidebar-heading clickable"><span>Transports</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/messages.html" class="sidebar-link">Messages</a></li><li><a href="/MassTransit/usage/consumers.html" class="sidebar-link">Consumers</a></li><li><a href="/MassTransit/usage/producers.html" class="sidebar-link">Producers</a></li><li><a href="/MassTransit/usage/exceptions.html" class="sidebar-link">Exceptions</a></li><li><a href="/MassTransit/usage/requests.html" class="sidebar-link">Requests</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/sagas/" class="sidebar-heading clickable router-link-active open"><span>Sagas</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/MassTransit/usage/sagas/automatonymous.html" class="active sidebar-link">Automatonymous</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#state-machine" class="sidebar-link">State Machine</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#instance" class="sidebar-link">Instance</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#state" class="sidebar-link">State</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#event" class="sidebar-link">Event</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#behavior" class="sidebar-link">Behavior</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#configuration" class="sidebar-link">Configuration</a></li></ul></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#event-2" class="sidebar-link">Event</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#ignore-event" class="sidebar-link">Ignore Event</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#composite-event" class="sidebar-link">Composite Event</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#missing-instance" class="sidebar-link">Missing Instance</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#initial-insert" class="sidebar-link">Initial Insert</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#completed-instance" class="sidebar-link">Completed Instance</a></li></ul></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#activities" class="sidebar-link">Activities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#publish" class="sidebar-link">Publish</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#send" class="sidebar-link">Send</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#respond" class="sidebar-link">Respond</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#schedule" class="sidebar-link">Schedule</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#request" class="sidebar-link">Request</a></li><li class="sidebar-sub-header"><a href="/MassTransit/usage/sagas/automatonymous.html#custom" class="sidebar-link">Custom</a></li></ul></li></ul></li><li><a href="/MassTransit/usage/sagas/persistence.html" class="sidebar-link">Saga Persistence</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/MassTransit/usage/containers/" class="sidebar-heading clickable"><span>Containers</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/MassTransit/usage/testing.html" class="sidebar-link">Testing</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Advanced</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/MassTransit/learn/" class="sidebar-heading clickable"><span>Getting Help</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Reference</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="automatonymous"><a href="#automatonymous" class="header-anchor">#</a> Automatonymous</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p><a href="https://github.com/MassTransit/Automatonymous" target="_blank" rel="noopener noreferrer">Automatonymous<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a state machine library for .NET and provides a C# syntax to define a state machine, including states, events, and behaviors. MassTransit includes Automatonymous, and adds instance storage, event correlation, message binding, request and response support, and scheduling. Like MassTransit, Automatonymous is free, open-source, and Apache 2.0 licensed.</p> <div class="custom-block tip"><p class="custom-block-title">V6</p> <p>Automatonymous is now included by default with <em>MassTransit</em>. In previous versions, an additional package reference was required. If <em>MassTransit.Automatonymous</em> was previously used, it must be removed as it is no longer compatible.</p></div> <h3 id="state-machine"><a href="#state-machine" class="header-anchor">#</a> State Machine</h3> <p>A state machine defines the states, events, and behavior of a finite state machine. Implemented as a class, which is derived from <code>MassTransitStateMachine&lt;T&gt;</code>, a state machine is created once, and then used to apply event triggered behavior to state machine <em>instances</em>.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="instance"><a href="#instance" class="header-anchor">#</a> Instance</h3> <p>An instance contains the data for a state machine <em>instance</em>. A new instance is created for every consumed <em>initial</em> event where an existing instance with the same <em>CorrelationId</em> was not found. A saga repository is used to persist instances. Instances are classes, and must implement the <code>SagaStateMachineInstance</code> interface.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InstanceState</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CurrentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>An instance must store the current state, which can be one of three types:</p> <table><thead><tr><th style="text-align:left;">Type</th> <th style="text-align:left;">Description</th></tr></thead> <tbody><tr><td style="text-align:left;">State</td> <td style="text-align:left;">The interface <code>State</code> type. Can be difficult to serialize, typically only used for in-memory instances, but could be used if the repository storage engine supports mapping user types to a storage type.</td></tr> <tr><td style="text-align:left;">string</td> <td style="text-align:left;">Easy, stores the state name. However, it takes a lot of space as the state name is repeated for every instance.</td></tr> <tr><td style="text-align:left;">int</td> <td style="text-align:left;">Small, fast, but requires that each possible state be specified, in order, to assign <em>int</em> values to each state.</td></tr></tbody></table> <p>The <em>CurrentState</em> instance state property is automatically configured if it is a <code>State</code>. For <code>string</code> or <code>int</code> types, the <code>InstanceState</code> method must be used.</p> <p>To specify the <em>int</em> state values, configure the instance state as shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">InstanceState</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CurrentState<span class="token punctuation">,</span> Submitted<span class="token punctuation">,</span> Accepted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This results in the following values: 0 - Initial, 1 - Final, 2 - Submitted, 3 - Accepted</p> <h3 id="state"><a href="#state" class="header-anchor">#</a> State</h3> <p>States represent previously consumed events resulting in an instance being in a current <em>state</em>. An instance can only be in one state at a given time. A new instance defaults to the <em>Initial</em> state, which is automatically defined. The <em>Final</em> state is also defined for all state machines and is used to signfify the instance has reached the final state.</p> <p>In the example, two states are declared. States are automatically initialized by the <em>MassTransitStateMachine</em> base class constructor.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> Submitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> Accepted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="event"><a href="#event" class="header-anchor">#</a> Event</h3> <p>An event is something that happened which may result in a state change. An event can add or update instance data, as well as changing an instance's current state. The <code>Event&lt;T&gt;</code> is generic, where <code>T</code> must be a valid message type.</p> <p>In the example below, the <em>SubmitOrder</em> message is declared as an event including how to correlate the event to an instance.</p> <blockquote><p>Unless events implement <code>CorrelatedBy&lt;Guid&gt;</code>, they must be declared with a correlation expression.</p></blockquote> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>SubmitOrder<span class="token operator">&gt;</span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="behavior"><a href="#behavior" class="header-anchor">#</a> Behavior</h3> <p>Behavior is what happens when an <em>event</em> occurs during a <em>state</em>.</p> <p>Below, the <em>Initially</em> block is used to define the behavior of the <em>SubmitOrder</em> event during the <em>Initial</em> state. When a <em>SubmitOrder</em> message is consumed and an instance with a <em>CorrelationId</em> matching the <em>OrderId</em> is not found, a new instance will be created in the <em>Initial</em> state. The <em>TransitionTo</em> activity transitions the instance to the <em>Submitted</em> state, after which the instance is persisted using the saga repository.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Subsequently, the <em>OrderAccepted</em> event could be handled by the behavior shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderAccepted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderAccepted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>OrderAccepted<span class="token operator">&gt;</span> OrderAccepted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="message-order"><a href="#message-order" class="header-anchor">#</a> Message Order</h4> <p>Message brokers typically do not guarantee message order. Therefore, it is important to consider out-of-order messages in state machine design.</p> <p>In the example above, receiving a <em>SubmitOrder</em> message after an <em>OrderAccepted</em> event could cause the <em>SubmitOrder</em> message to end up in the <em>_error</em> queue. If the <em>OrderAccepted</em> event is received first, it would be discarded since it isn't accepted in the <em>Initial</em> state. Below is an updated state machine that handles both of these scenarios.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">Ignore</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In the updated example, receiving a <em>SubmitOrder</em> message while in an <em>Accepted</em> state ignores the event. However, data in the event may be useful. In that case, adding behavior to copy the data to the instance could be added. Below, data from the event is captured in both scenarios.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token class-name">DateTime</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> DateTime<span class="token punctuation">?</span> OrderDate <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> x<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>OrderDate<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>OrderDate <span class="token operator">=</span> x<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>OrderDate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h3> <p>To add a state machine saga to a receive endpoint:</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">var</span> machine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> repository <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">InMemorySagaRepository</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderState</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> busControl <span class="token operator">=</span> Bus<span class="token punctuation">.</span>Factory<span class="token punctuation">.</span><span class="token function">CreateUsingInMemory</span><span class="token punctuation">(</span>cfg <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>    
    cfg<span class="token punctuation">.</span><span class="token function">ReceiveEndpoint</span><span class="token punctuation">(</span><span class="token string">&quot;order&quot;</span><span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">StateMachineSaga</span><span class="token punctuation">(</span>machine<span class="token punctuation">,</span> repository<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The example above uses the in-memory saga repository, but any saga repository could be used. The <a href="/MassTransit/usage/sagas/persistence.html">persistence</a> section includes details on the supported saga repositories.</p> <p>To test the state machine, see the <a href="/MassTransit/usage/testing.html#state-machine-saga">testing</a> section.</p> <h2 id="event-2"><a href="#event-2" class="header-anchor">#</a> Event</h2> <p>As shown above, an event is a message that can be consumed by the state machine. Events can specify any valid message type, and each event may be configured. There are several event configuration methods available.</p> <p>The built-in <code>CorrelatedBy&lt;Guid&gt;</code> interface can be used in a message contract to specify the event <code>CorrelationId</code>.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCanceled</span> <span class="token punctuation">:</span>
    <span class="token class-name">CorrelatedBy</span><span class="token operator">&lt;</span>Guid<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCanceled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// not required, as it is the default convention</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>While the event is declared explicitly above, it is not required. The default convention will automatically configure events that have a <code>CorrelatedBy&lt;Guid&gt;</code> interface.</p> <blockquote><p>While convenient, some consider the interface an intrusion of infrastructure to the message contract.</p></blockquote> <p>An alternative is to declare the event correlation, as shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>    
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>SubmitOrder<span class="token operator">&gt;</span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Since <code>OrderId</code> is a <code>Guid</code>, it can be used for event correlation. When <code>SubmitOrder</code> is accepted in the <em>Initial</em> state, and because the <em>OrderId</em> is a <em>Guid</em>, the <code>CorrelationId</code> on the new instance is automatically assigned the <em>OrderId</em> value.</p> <p>To correlate events using another type, additional configuration is required.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExternalOrderSubmitted</span>
<span class="token punctuation">{</span>    
    <span class="token keyword">string</span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ExternalOrderSubmitted<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> e
            <span class="token punctuation">.</span><span class="token function">CorrelateBy</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>ExternalOrderSubmitted<span class="token operator">&gt;</span> ExternalOrderSubmitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the event doesn't have a <em>Guid</em> that uniquely correlates to an instance, the <code>.SelectId</code> expression must be configured. In the above example, <a href="https://www.nuget.org/packages/NewId" target="_blank" rel="noopener noreferrer">NewId<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is used to generate a sequential identifier which will be assigned to the instance <em>CorrelationId</em>. Any property on the event can be used to initialize the <em>CorrelationId</em>.</p> <p>The message headers are also available, for example, instead of always generating a new identifier, the <em>CorrelationId</em> header could be used if present.</p> <div class="language-cs extra-class"><pre class="language-cs"><code>            <span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>CorrelationId <span class="token operator">??</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Event correlation is critical, and should be consistently applied to all events on a state machine. Consider how events received in different orders may affect subsequent event correlations.</p></div> <h3 id="ignore-event"><a href="#ignore-event" class="header-anchor">#</a> Ignore Event</h3> <p>It may be necessary to ignore an event in a given state, either to avoid fault generation, or to prevent messages from being moved to the <em>_skipped</em> queue. To ignore an event in a state, use the <code>Ignore</code> method.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">Ignore</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="composite-event"><a href="#composite-event" class="header-anchor">#</a> Composite Event</h3> <p>A composite event is configured by specifying one or more events that must be consumed, after which the composite event will be raised. A composite event uses an instance property to keep track of the required events, which is specified during configuration.</p> <p>To define a composite event, the required events must first be configured along with any event behaviors, after which the composite event can be configured.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> ReadyEventStatus <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">CompositeEvent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderReady<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ReadyEventStatus<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">,</span> OrderAccepted<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderReady<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Order Ready: {0}&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Event</span> OrderReady <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once the <em>SubmitOrder</em> and <em>OrderAccepted</em> events have been consumed, the <em>OrderReady</em> event will be triggered.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>The order of events being declared can impact the order in which they execute. Therefore, it is best to declare composite events at the end of the state machine declaration, after all other events and behaviors are declared. That way, the composite events will be raised <em>after</em> the dependent event behaviors.</p></div> <h3 id="missing-instance"><a href="#missing-instance" class="header-anchor">#</a> Missing Instance</h3> <p>If an event is not matching to an instance, the missing instance behavior can be configured.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestOrderCancellation</span>
<span class="token punctuation">{</span>    
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderNotFound</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCancellationRequested<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span><span class="token function">OnMissingInstance</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderNotFound</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>RequestOrderCancellation<span class="token operator">&gt;</span> OrderCancellationRequested <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>In this example, when a cancel order request is consumed without a matching instance, a response will be sent that the order was not found. Instead of generating a <code>Fault</code>, the response is more explicit. Other missing instance options include <code>Discard</code>, <code>Fault</code>, and <code>Execute</code> (a synchronous version of <em>ExecuteAsync</em>).</p> <h3 id="initial-insert"><a href="#initial-insert" class="header-anchor">#</a> Initial Insert</h3> <p>To increase new instance performance, configuring an event to directly insert into a saga repository may reduce lock contention. To configure an event to insert, it should be in the <em>Initially</em> block, as well as have a saga factory specified.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubmitOrder</span>
<span class="token punctuation">{</span>    
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> SubmitOrder<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span>InsertOnInitial <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">SetSagaFactory</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">OrderState</span>
            <span class="token punctuation">{</span>
                CorrelationId <span class="token operator">=</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>SubmitOrder<span class="token operator">&gt;</span> SubmitOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When using <em>InsertOnInitial</em>, it is critical that the saga repository is able to detect duplicate keys (in this case, <em>CorrelationId</em> - which is initialized using <em>OrderId</em>). In this case, having a clustered primary key on <em>CorrelationId</em> would prevent duplicate instances from being inserted. If an event is correlated using a different property, make sure that the database enforces a unique constraint on the instance property and the saga factory initializes the instance property with the event property value.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ExternalOrderSubmitted</span>
<span class="token punctuation">{</span>    
    <span class="token keyword">string</span> OrderNumber <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ExternalOrderSubmitted<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateBy</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> i<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">)</span>
            e<span class="token punctuation">.</span><span class="token function">SelectId</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span>InsertOnInitial <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">SetSagaFactory</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">OrderState</span>
            <span class="token punctuation">{</span>
                CorrelationId <span class="token operator">=</span> context<span class="token punctuation">.</span>CorrelationId <span class="token operator">??</span> NewId<span class="token punctuation">.</span><span class="token function">NextGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                OrderNumber <span class="token operator">=</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderNumber<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>ExternalOrderSubmitted<span class="token operator">&gt;</span> ExternalOrderSubmitted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The database would use a unique constraint on the <em>OrderNumber</em> to prevent duplicates, which the saga repository would detect as an existing instance, which would then be loaded to consume the event.</p> <h3 id="completed-instance"><a href="#completed-instance" class="header-anchor">#</a> Completed Instance</h3> <p>By default, instances are not removed from the saga repository. To configure completed instance removal, specify the method used to determine if an instance has completed.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompleted</span>
<span class="token punctuation">{</span>    
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCompleted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCompleted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">SetCompletedWhenFinalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>OrderCompleted<span class="token operator">&gt;</span> OrderCompleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the instance consumes the <em>OrderCompleted</em> event, the instance is finalized (which transitions the instance to the <em>Final</em> state). The <code>SetCompletedWhenFinalized</code> method defines an instance in the <em>Final</em> state as completed  which is then used by the saga repository to remove the instance.</p> <p>To use a different completed expression, such as one that checks if the instance is in a <em>Completed</em> state, use the <code>SetCompleted</code> method as shown below.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompleted</span>
<span class="token punctuation">{</span>    
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCompleted<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCompleted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Completed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">SetCompleted</span><span class="token punctuation">(</span><span class="token keyword">async</span> instance <span class="token operator">=&gt;</span> 
        <span class="token punctuation">{</span>
            State<span class="token operator">&lt;</span>TInstance<span class="token operator">&gt;</span> currentState <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> Completed<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>currentState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">State</span> Completed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>OrderCompleted<span class="token operator">&gt;</span> OrderCompleted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="activities"><a href="#activities" class="header-anchor">#</a> Activities</h2> <p>State machine behaviors are defined as a sequence of activities which are executed in response to an event. In addition to the activities included with Automatonymous, MassTransit includes activities to send, publish, and schedule messages, as well as initiate and respond to requests.</p> <h3 id="publish"><a href="#publish" class="header-anchor">#</a> Publish</h3> <p>To publish an event, add a <code>Publish</code> activity.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderSubmittedEvent</span> <span class="token punctuation">:</span>
    <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderSubmittedEvent</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>OrderSubmitted<span class="token punctuation">)</span><span class="token keyword">new</span> <span class="token class-name">OrderSubmittedEvent</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Alternatively, a message initializer can be used to eliminate the <em>Event</em> class.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderSubmitted</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="send"><a href="#send" class="header-anchor">#</a> Send</h3> <p>To send a message, add a <code>Send</code> activity.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpdateAccountHistory</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateAccountHistoryCommand</span> <span class="token punctuation">:</span>
    <span class="token class-name">UpdateAccountHistory</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">UpdateAccountHistoryCommand</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> orderId<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        OrderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token class-name">OrderStateMachineSettings</span> settings<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AccountServiceAddress<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">UpdateAccountHistoryCommand</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Alternatively, a message initializer can be used to eliminate the <em>Command</em> class.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UpdateAccountHistory</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token class-name">OrderStateMachineSettings</span> settings<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>AccountServiceAddress<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">UpdateAccountHistory</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="respond"><a href="#respond" class="header-anchor">#</a> Respond</h3> <p>A state machine can respond to requests by configuring the request message type as an event, and using the <code>Respond</code> method. When configuring a request event, configuring a missing instance method is recommended, to provide a better response experience (either through a different response type, or a response that indicates an instance was not found).</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RequestOrderCancellation</span>
<span class="token punctuation">{</span>    
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCanceled</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderNotFound</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Event</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCancellationRequested<span class="token punctuation">,</span> e <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

            e<span class="token punctuation">.</span><span class="token function">OnMissingInstance</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> m<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">RespondAsync</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderNotFound</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> x<span class="token punctuation">.</span>OrderId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCancellationRequested<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">RespondAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderCanceled</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Canceled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">State</span> Canceled <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Event<span class="token operator">&lt;</span>RequestOrderCancellation<span class="token operator">&gt;</span> OrderCancellationRequested <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="schedule"><a href="#schedule" class="header-anchor">#</a> Schedule</h3> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The bus must be configured to include a message scheduler to use the scheduling activities. See the <a href="/MassTransit/advanced/scheduling/">scheduling</a> section to learn how to setup a message scheduler.</p></div> <p>A state machine can schedule events, which uses the message scheduler to schedule a message for delivery to the instance. First, the schedule must be declared.</p> <div class="language-cs extra-class"><div class="highlight-lines"><div class="highlighted"></div><div class="highlighted"></div><div class="highlighted"></div><div class="highlighted"></div><br><br><br><br><br><br><br><div class="highlighted"></div><br><br><br><br><br><br><br><div class="highlighted"></div><div class="highlighted"></div><div class="highlighted"></div><div class="highlighted"></div><div class="highlighted"></div><div class="highlighted"></div><br><br><div class="highlighted"></div><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompletionTimeoutExpired</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Guid<span class="token punctuation">?</span> OrderCompletionTimeoutTokenId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> OrderCompletionTimeout<span class="token punctuation">,</span> instance <span class="token operator">=&gt;</span> instance<span class="token punctuation">.</span>OrderCompletionTimeoutTokenId<span class="token punctuation">,</span> s <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            s<span class="token punctuation">.</span>Delay <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromDays</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            s<span class="token punctuation">.</span>Received <span class="token operator">=</span> r <span class="token operator">=&gt;</span> r<span class="token punctuation">.</span><span class="token function">CorrelateById</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>OrderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Schedule<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> OrderCompletionTimeoutExpired<span class="token operator">&gt;</span> OrderCompletionTimeout <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The configuration specifies the <em>Delay</em>, which can be overridden by the schedule activity, and the correlation expression for the <em>Received</em> event. The state machine can consume the <em>Received</em> event as shown. The <em>OrderCompletionTimeoutTokenId</em> is a <code>Guid?</code> instance property used to keep track of the scheduled message <em>tokenId</em> which can later be used to unschedule the event.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"></div><br><br><br><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderCompleted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">.</span>Received<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderCompleted</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Schedule<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> OrderCompletionTimeoutExpired<span class="token operator">&gt;</span> OrderCompletionTimeout <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The event can be scheduled using the <code>Schedule</code> activity.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"></div><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderCompletionTimeoutExpired</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>As stated above, the <em>delay</em> can be overridden by the <em>Schedule</em> activity. Both instance and message (<em>context.Data</em>) content can be used to calculate the delay.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"></div><div class="highlighted"></div><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderAccepted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
    <span class="token class-name">TimeSpan</span> CompletionTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">,</span> context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderCompletionTimeoutExpired</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>CompletionTime<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Accepted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once the scheduled event is received, the <code>OrderCompletionTimeoutTokenId</code> property is cleared.</p> <p>If the scheduled event is no longer needed, the <em>Unschedule</em> activity can be used.</p> <div class="language-cs extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"></div><br><br><br><br></div><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderAccepted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
    <span class="token class-name">TimeSpan</span> CompletionTime <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">DuringAny</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderCancellationRequested<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">RespondAsync</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderCanceled</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Unschedule</span><span class="token punctuation">(</span>OrderCompletionTimeout<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Canceled<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="request"><a href="#request" class="header-anchor">#</a> Request</h3> <p>A request can be sent from a state machine using the <em>Request</em> method. Defining a request includes specifying an instance property to store the <em>RequestId</em> so that response event(s) can be correlated to the instance, as well as specifying a default request timeout.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The bus must be configured to include a message scheduler to use the request activities. See the <a href="/MassTransit/advanced/scheduling/">scheduling</a> section to learn how to setup a message scheduler.</p></div> <p>To declare a request, add a <code>Request</code> property and configure it using the <code>Request</code> method.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProcessOrder</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderProcessed</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token class-name">Guid</span> ProcessingId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderState</span> <span class="token punctuation">:</span>
    <span class="token class-name">SagaStateMachineInstance</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Guid</span> CorrelationId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> CurrentState <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Guid<span class="token punctuation">?</span> ProcessOrderRequestId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> Guid<span class="token punctuation">?</span> ProcessingId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token class-name">OrderStateMachineSettings</span> settings<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Request</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> ProcessOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>ProcessOrderRequestId<span class="token punctuation">,</span> r <span class="token operator">=&gt;</span>
        <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>ServiceAddress <span class="token operator">=</span> settings<span class="token punctuation">.</span>ProcessOrderServiceAddress<span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>Timeout <span class="token operator">=</span> settings<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Request<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> ProcessOrder<span class="token punctuation">,</span> OrderProcessed<span class="token operator">&gt;</span> ProcessOrder <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once defined, the request activity can be added to a behavior.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">During</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>OrderAccepted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">,</span> x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Init</span><span class="token punctuation">&lt;</span><span class="token class-name">ProcessOrder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> x<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Pending<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">During</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Pending<span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Completed<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Then</span><span class="token punctuation">(</span>context <span class="token operator">=&gt;</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>ProcessingId <span class="token operator">=</span> context<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>ProcessingId<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Processed<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>Faulted<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessFaulted<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">When</span><span class="token punctuation">(</span>ProcessOrder<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>ProcessTimeoutExpired<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">State</span> Processed <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> ProcessFaulted <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">State</span> ProcessTimeoutExpired <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The <em>Request</em> includes three events: _Completed, <em>Faulted</em>, and <em>TimeoutExpired</em>. These events can be consumed during any state, however, the <em>Request</em> includes a <em>Pending</em> state which can be used to avoid declaring a separate pending state.</p> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The request timeout is scheduled using the message scheduler, and the scheduled message is canceled when a response or fault is received. Not all message schedulers support cancellation, so it may be necessary to <em>Ignore</em> the <code>TimeoutExpired</code> event in subsequent states.</p></div> <h3 id="custom"><a href="#custom" class="header-anchor">#</a> Custom</h3> <p>There are scenarios when an event behavior may have dependencies that need to be managed at a scope level, such as a database connection, or the complexity is best encapsulated in a separate class rather than being part of the state machine itself. Developers can create their own activities for state machine use, and optionally create their own extension methods to add them to a behavior.</p> <p>To create an activity, create a class that implements <code>IActivity&lt;TInstance, TData&gt;</code> as shown.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublishOrderSubmittedActivity</span> <span class="token punctuation">:</span>
    <span class="token class-name">Activity</span><span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> <span class="token class-name">ConsumeContext</span> _context<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PublishOrderSubmittedActivity</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token string">&quot;publish-order-submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token class-name">StateMachineVisitor</span> visitor<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span>BehaviorContext<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token operator">&gt;</span> context<span class="token punctuation">,</span> Behavior<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// do the activity thing</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderSubmitted</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// call the next activity in the behavior</span>
        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Task <span class="token generic-method"><span class="token function">Faulted</span><span class="token punctuation">&lt;</span><span class="token class-name">TException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>BehaviorExceptionContext<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token punctuation">,</span> TException<span class="token operator">&gt;</span> context<span class="token punctuation">,</span> Behavior<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> SubmitOrder<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
        <span class="token keyword">where</span> TException <span class="token punctuation">:</span> Exception
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Faulted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Once created, configure the activity in a state machine as shown.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Activity</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfType</span><span class="token punctuation">&lt;</span><span class="token class-name">PublishOrderSubmittedActivity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the <code>SubmitOrder</code> event is consumed, the state machine will resolve the activity from the container, and call the <code>Execute</code> method. The activity will be scoped, so any dependencies will be resolved within the message <code>ConsumeContext</code>.</p> <p>In the above example, the event type was known in advance. If an activity for any event type is needed, it can be created without specifying the event type.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PublishOrderSubmittedActivity</span> <span class="token punctuation">:</span>
    <span class="token class-name">Activity</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">readonly</span> <span class="token class-name">ConsumeContext</span> _context<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">PublishOrderSubmittedActivity</span><span class="token punctuation">(</span><span class="token class-name">ConsumeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Probe</span><span class="token punctuation">(</span><span class="token class-name">ProbeContext</span> context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        context<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token string">&quot;publish-order-submitted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Accept</span><span class="token punctuation">(</span><span class="token class-name">StateMachineVisitor</span> visitor<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        visitor<span class="token punctuation">.</span><span class="token function">Visit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span>BehaviorContext<span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span> context<span class="token punctuation">,</span> Behavior<span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderSubmitted</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token generic-method"><span class="token function">Execute</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>BehaviorContext<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token operator">&gt;</span> context<span class="token punctuation">,</span> Behavior<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Publish</span><span class="token punctuation">&lt;</span><span class="token class-name">OrderSubmitted</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> OrderId <span class="token operator">=</span> context<span class="token punctuation">.</span>Instance<span class="token punctuation">.</span>CorrelationId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> next<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Task <span class="token generic-method"><span class="token function">Faulted</span><span class="token punctuation">&lt;</span><span class="token class-name">TException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>BehaviorExceptionContext<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> TException<span class="token operator">&gt;</span> context<span class="token punctuation">,</span> Behavior<span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span> next<span class="token punctuation">)</span> 
        <span class="token keyword">where</span> TException <span class="token punctuation">:</span> Exception
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Faulted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Task <span class="token generic-method"><span class="token function">Faulted</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">TException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>BehaviorExceptionContext<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token punctuation">,</span> TException<span class="token operator">&gt;</span> context<span class="token punctuation">,</span> Behavior<span class="token operator">&lt;</span>OrderState<span class="token punctuation">,</span> T<span class="token operator">&gt;</span> next<span class="token punctuation">)</span>
        <span class="token keyword">where</span> TException <span class="token punctuation">:</span> Exception
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> next<span class="token punctuation">.</span><span class="token function">Faulted</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>To register an instance activity, use the following syntax.</p> <div class="language-cs extra-class"><pre class="language-cs"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderSubmitted</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Guid</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderStateMachine</span> <span class="token punctuation">:</span>
    <span class="token class-name">MassTransitStateMachine</span><span class="token operator">&lt;</span>OrderState<span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderStateMachine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">Initially</span><span class="token punctuation">(</span>
            <span class="token function">When</span><span class="token punctuation">(</span>SubmitOrder<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Activity</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span> x<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">OfInstanceType</span><span class="token punctuation">&lt;</span><span class="token class-name">PublishOrderSubmittedActivity</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">TransitionTo</span><span class="token punctuation">(</span>Submitted<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/MassTransit/MassTransit/edit/develop/docs/usage/sagas/automatonymous.md" target="_blank" rel="noopener noreferrer">Help us by improving this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/15/2019, 1:11:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/MassTransit/usage/requests.html" class="prev">Requests</a></span> <span class="next"><a href="/MassTransit/usage/sagas/persistence.html">Saga Persistence</a>
      
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/MassTransit/assets/js/app.763fcc25.js" defer></script><script src="/MassTransit/assets/js/6.b9c46cbe.js" defer></script><script src="/MassTransit/assets/js/1.f2cfa088.js" defer></script><script src="/MassTransit/assets/js/101.fdf33797.js" defer></script>
  </body>
</html>
